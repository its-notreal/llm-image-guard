<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <svg width="24" height="24" viewBox="0 0 48 48" fill="none">
            <path d="M24 4L42 14V28C42 36 34 44 24 48C14 44 6 36 6 28V14L24 4Z" stroke="currentColor" stroke-width="3" fill="none"/>
            <circle cx="24" cy="24" r="8" stroke="currentColor" stroke-width="2.5" fill="none"/>
            <circle cx="24" cy="24" r="3" fill="currentColor"/>
          </svg>
        </div>
        <h1>Image Guard</h1>
      </div>
      <label class="master-toggle">
        <input type="checkbox" id="masterEnabled" checked>
        <span class="toggle-slider"></span>
      </label>
    </header>

    <nav class="tabs">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="filters">Filters</button>
      <button class="tab" data-tab="settings">Settings</button>
    </nav>

    <main class="content">
      <!-- Dashboard Tab -->
      <section id="tab-dashboard" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statScanned">0</div>
            <div class="stat-label">Images Scanned</div>
          </div>
          <div class="stat-card blocked">
            <div class="stat-value" id="statBlocked">0</div>
            <div class="stat-label">Images Blocked</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statAllowed">0</div>
            <div class="stat-label">Images Allowed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statCached">0</div>
            <div class="stat-label">Cache Hits</div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <h3>Current Page</h3>
            <button id="rescanPage" class="btn-icon" title="Rescan page">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6M1 20v-6h6"/>
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
              </svg>
            </button>
          </div>
          <div class="page-info">
            <div class="page-url" id="currentPageUrl">-</div>
            <div class="page-stats">
              <span><strong id="pageScanned">0</strong> scanned</span>
              <span class="divider">|</span>
              <span><strong id="pageBlocked">0</strong> blocked</span>
            </div>
          </div>
        </div>

        <div class="section-card">
          <h3>Quick Actions</h3>
          <div class="quick-actions">
            <button id="whitelistSite" class="btn-secondary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                <path d="M9 12l2 2 4-4"/>
              </svg>
              Whitelist This Site
            </button>
            <button id="pauseScanning" class="btn-secondary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
              </svg>
              Pause Scanning
            </button>
          </div>
        </div>

        <div class="section-card mode-card">
          <h3>Operating Mode</h3>
          <div class="mode-selector">
            <label class="mode-option">
              <input type="radio" name="operatingMode" value="block" checked>
              <div class="mode-content">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                </svg>
                <div>
                  <strong>Block Mode</strong>
                  <span>Hide matching images completely</span>
                </div>
              </div>
            </label>
            <label class="mode-option">
              <input type="radio" name="operatingMode" value="test">
              <div class="mode-content">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <path d="M9 9h6v6H9z"/>
                </svg>
                <div>
                  <strong>Test Mode</strong>
                  <span>Show grey placeholders instead</span>
                </div>
              </div>
            </label>
          </div>
        </div>
      </section>

      <!-- Filters Tab -->
      <section id="tab-filters" class="tab-content">
        <div class="section-card">
          <div class="section-header">
            <h3>Content Categories</h3>
            <button id="addCategory" class="btn-small">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add Category
            </button>
          </div>
          <p class="section-desc">Enable categories to block. The AI will analyze images against these content types.</p>
          
          <div id="categoriesList" class="categories-list">
            <!-- Categories populated by JS -->
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <h3>Custom Rules</h3>
          </div>
          <p class="section-desc">Add specific content descriptions to block (one per line).</p>
          <textarea id="customRules" class="custom-rules" placeholder="Example:&#10;images containing weapons&#10;graphic medical procedures&#10;disturbing or scary faces"></textarea>
        </div>

        <div class="section-card">
          <div class="section-header">
            <h3>Whitelisted Sites</h3>
          </div>
          <p class="section-desc">Images on these sites will never be blocked.</p>
          <div id="whitelistContainer" class="whitelist-container">
            <!-- Whitelist items populated by JS -->
          </div>
          <div class="whitelist-input-row">
            <input type="text" id="whitelistInput" placeholder="example.com" class="whitelist-input">
            <button id="addWhitelist" class="btn-small">Add</button>
          </div>
        </div>
      </section>

      <!-- Settings Tab -->
      <section id="tab-settings" class="tab-content">
        <div class="section-card">
          <h3>API Configuration</h3>
          <div class="form-group">
            <label for="apiKey">OpenRouter API Key</label>
            <div class="input-with-action">
              <input type="password" id="apiKey" placeholder="sk-or-v1-...">
              <button id="toggleApiKey" class="btn-icon" title="Show/hide">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </div>
            <a href="https://openrouter.ai/keys" target="_blank" class="help-link">Get an API key from OpenRouter</a>
          </div>

          <div class="form-group">
            <label for="modelSearch">AI Model</label>
            <div class="model-selector">
              <div class="model-search-container">
                <input type="text" id="modelSearch" placeholder="Search models..." autocomplete="off">
                <div class="model-dropdown" id="modelDropdown">
                  <div class="model-dropdown-content" id="modelList">
                    <!-- Models populated by JS -->
                  </div>
                </div>
              </div>
              <div class="selected-model" id="selectedModel">
                <span class="model-name">No model selected</span>
                <button id="clearModel" class="btn-icon-small" title="Clear selection">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              </div>
            </div>
            <p class="help-text">Choose a vision-capable model. Recommended: GPT-4o Mini, Claude 3 Haiku, or Gemini Flash for best speed/cost.</p>
          </div>
        </div>

        <div class="section-card">
          <h3>Scanning Options</h3>
          
          <div class="form-group">
            <label for="minImageSize">Minimum Image Size</label>
            <div class="range-input">
              <input type="range" id="minImageSize" min="32" max="300" value="100">
              <span id="minImageSizeValue">100px</span>
            </div>
            <p class="help-text">Smaller images (icons, avatars) will be skipped.</p>
          </div>

          <div class="form-group">
            <label for="sensitivity">Detection Sensitivity</label>
            <div class="range-input">
              <input type="range" id="sensitivity" min="1" max="5" value="3">
              <span id="sensitivityValue">Medium</span>
            </div>
            <p class="help-text">Higher sensitivity blocks more aggressively but may have false positives.</p>
          </div>

          <label class="checkbox-option">
            <input type="checkbox" id="usePageContext" checked>
            <span class="checkmark"></span>
            <div>
              <strong>Use page context</strong>
              <span>Include surrounding text and page info for better accuracy</span>
            </div>
          </label>

          <label class="checkbox-option">
            <input type="checkbox" id="scanLazyImages" checked>
            <span class="checkmark"></span>
            <div>
              <strong>Scan lazy-loaded images</strong>
              <span>Monitor for new images as you scroll</span>
            </div>
          </label>
        </div>

        <div class="section-card">
          <h3>Data & Privacy</h3>
          <div class="action-buttons">
            <button id="clearCache" class="btn-secondary">Clear Analysis Cache</button>
            <button id="resetStats" class="btn-secondary">Reset Statistics</button>
            <button id="exportSettings" class="btn-secondary">Export Settings</button>
            <button id="importSettings" class="btn-secondary">Import Settings</button>
          </div>
          <input type="file" id="importFile" accept=".json" style="display: none;">
        </div>
      </section>
    </main>

    <footer class="footer">
      <button id="saveSettings" class="btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
          <polyline points="17,21 17,13 7,13 7,21"/>
          <polyline points="7,3 7,8 15,8"/>
        </svg>
        Save Changes
      </button>
      <div id="saveStatus" class="save-status"></div>
    </footer>
  </div>

  <!-- Add Category Modal -->
  <div id="addCategoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Content Category</h3>
        <button class="modal-close" data-close-modal>&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="categoryName">Category Name</label>
          <input type="text" id="categoryName" placeholder="e.g., Violence">
        </div>
        <div class="form-group">
          <label for="categoryDescription">Description (for AI)</label>
          <textarea id="categoryDescription" placeholder="Describe what content should be blocked. Be specific.&#10;&#10;e.g., Images depicting physical violence, fighting, injuries, blood, or weapons being used against people or animals"></textarea>
        </div>
        <div class="form-group">
          <label for="categoryIcon">Icon</label>
          <div class="icon-picker" id="iconPicker">
            <button class="icon-option selected" data-icon="ban">üö´</button>
            <button class="icon-option" data-icon="warning">‚ö†Ô∏è</button>
            <button class="icon-option" data-icon="skull">üíÄ</button>
            <button class="icon-option" data-icon="fire">üî•</button>
            <button class="icon-option" data-icon="eye">üëÅÔ∏è</button>
            <button class="icon-option" data-icon="shield">üõ°Ô∏è</button>
            <button class="icon-option" data-icon="heart">‚ù§Ô∏è</button>
            <button class="icon-option" data-icon="star">‚≠ê</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal>Cancel</button>
        <button id="saveCategoryBtn" class="btn-primary">Add Category</button>
      </div>
    </div>
  </div>

  <script src="popup.js"></script>
</body>
</html>
